<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="icon" href="/favicon.jpg" type="image/jpeg"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet"/>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <title>Report Breakdown - Driver Reporting System</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Primary Background */
        }
        .header {
            background-color: #1f2937; /* Dark Charcoal Header */
            border-bottom: 1px solid #374151;
        }
        .header-title {
            color: #ffffff;
            font-weight: 700;
        }
        .nav-link {
            color: #d1d5db; /* Lighter text for nav links */
            font-weight: 500;
            transition: color 0.2s;
        }
        .nav-link:hover, .nav-link-active {
            color: #ffffff; /* Brighter on hover/active */
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.05), 0 1px 2px -1px rgb(0 0 0 / 0.05);
        }
        .btn-primary {
            background-color: #3b82f6; /* Vibrant Blue Accent */
            color: #ffffff;
            font-weight: 600;
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.625rem 1.25rem;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        .form-input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #bfdbfe;
        }
    </style>
    <script>
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                showError({code: 0});
            }
        }

        function showPosition(position) {
            document.getElementById("location").value = `Lat: ${position.coords.latitude}, Lon: ${position.coords.longitude}`;
        }

        function showError(error) {
            let errorMessage = "An unknown error occurred.";
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = "User denied the request for Geolocation.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = "Location information is unavailable.";
                    break;
                case error.TIMEOUT:
                    errorMessage = "The request to get user location timed out.";
                    break;
            }
            console.error(errorMessage);
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-white">Driver Reporting System</h1>
                    </div>
                </div>

                <nav class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="/report_breakdown.html" class="px-3 py-2 rounded-md text-sm font-medium text-white transition-colors duration-200">Report Breakdown</a>
                        <a href="/request_break.html" class="px-3 py-2 rounded-md text-sm font-medium text-white transition-colors duration-200">Request Break</a>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">Report Breakdown</h1>
            <p class="text-slate-600">Submit a breakdown report for your truck. Provide detailed information to help our maintenance team respond quickly.</p>
        </div>

        <div id="successMessage" class="hidden mb-6 bg-green-50 border border-green-200 rounded-lg p-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-green-800">Breakdown Report Submitted Successfully</h3>
                    <div class="mt-2 text-sm text-green-700">
                        <p>Your breakdown report has been submitted and our maintenance team has been notified, including all details provided.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="errorMessage" class="hidden mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">Error Submitting Report</h3>
                    <div class="mt-2 text-sm text-red-700">
                        <p id="errorText">There was an error submitting your breakdown report. Please try again later.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
            <form id="breakdownForm">
                <!-- Truck Registration Number -->
                <div class="mb-6">
                    <label for="truckRegistration" class="block text-sm font-medium text-slate-700 mb-2">
                        Truck Registration Number <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="truckRegistration" name="truckRegistration" required class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-slate-900" placeholder="Enter truck registration number (e.g., TRK-001)"/>
                </div>

                <!-- Fleet Number -->
                <div class="mb-6">
                    <label for="fleetNumber" class="block text-sm font-medium text-slate-700 mb-2">
                        Fleet Number <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="fleetNumber" name="fleetNumber" required class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-slate-900" placeholder="Enter fleet number"/>
                </div>

                <!-- Driver Full Names -->
                <div class="mb-6">
                    <label for="driverFullNames" class="block text-sm font-medium text-slate-700 mb-2">
                        Driver Full Names <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="driverFullNames" name="driverFullNames" required class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-slate-900" placeholder="Enter full names of the driver"/>
                </div>

                <!-- Cellphone Number -->
                <div class="mb-6">
                    <label for="cellphoneNumber" class="block text-sm font-medium text-slate-700 mb-2">
                        Cellphone Number <span class="text-red-500">*</span>
                    </label>
                    <input type="tel" id="cellphoneNumber" name="cellphoneNumber" required class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-slate-900" placeholder="Enter cellphone number"/>
                </div>

                <!-- Supervisor Name -->
                <div class="mb-6">
                    <label for="supervisorName" class="block text-sm font-medium text-slate-700 mb-2">
                        Supervisor Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="supervisorName" name="supervisorName" required class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-slate-900" placeholder="Enter supervisor name"/>
                </div>

                <!-- Supervisor Cellphone Number -->
                <div class="mb-6">
                    <label for="supervisorCellphone" class="block text-sm font-medium text-slate-700 mb-2">
                        Supervisor Cellphone Number <span class="text-red-500">*</span>
                    </label>
                    <input type="tel" id="supervisorCellphone" name="supervisorCellphone" required class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-slate-900" placeholder="Enter supervisor cellphone number"/>
                </div>

                <!-- Company Name -->
                <div class="mb-6">
                    <label for="companyName" class="block text-sm font-medium text-slate-700 mb-2">
                        Company Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="companyName" name="companyName" required class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-slate-900" placeholder="Enter company name"/>
                </div>

                <!-- Location -->
                <div class="mb-6">
                    <label for="location" class="block text-sm font-medium text-slate-700 mb-2">
                        Breakdown Location <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="location" name="location" required class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-slate-900" placeholder="Location will auto-capture" readonly/>
                </div>

                <!-- Issue Description -->
                <div class="mb-6">
                    <label for="issueDescription" class="block text-sm font-medium text-slate-700 mb-2">
                        Issue Description <span class="text-red-500">*</span>
                    </label>
                    <div id="editor" class="bg-white border border-slate-300 rounded-md" style="min-height: 150px;"></div>
                    <p class="mt-2 text-sm text-slate-500">Provide a detailed description of the breakdown, including any symptoms, error messages, or observations.</p>
                </div>

                <!-- Slip Picture Upload -->
                <div class="mb-6">
                    <label for="slipPicture" class="block text-sm font-medium text-slate-700 mb-2">
                        Slip Picture Upload <span class="text-red-500">*</span>
                    </label>
                    <input type="file" id="slipPicture" name="slipPicture" required class="w-full border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
                </div>

                <!-- Seal 1 Picture Upload -->
                <div class="mb-6">
                    <label for="seal1Picture" class="block text-sm font-medium text-slate-700 mb-2">
                        Seal 1 Picture Upload <span class="text-red-500">*</span>
                    </label>
                    <input type="file" id="seal1Picture" name="seal1Picture" required class="w-full border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
                </div>

                <!-- Seal 2 Picture Upload -->
                <div class="mb-6">
                    <label for="seal2Picture" class="block text-sm font-medium text-slate-700 mb-2">
                        Seal 2 Picture Upload <span class="text-red-500">*</span>
                    </label>
                    <input type="file" id="seal2Picture" name="seal2Picture" required class="w-full border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end">
                    <button type="submit" id="submitBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        <span id="submitBtnText">Submit Breakdown Report</span>
                        <svg id="submitSpinner" class="hidden animate-spin -mr-1 ml-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </main>

    <script>
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        }
    </script>

    <script type="module">
        import ClientAPI from '/client.js';

        const client = new ClientAPI();
        let quill;

        // Initialize Quill editor
        function initializeQuill() {
            quill = new Quill('#editor', {
                theme: 'snow',
                placeholder: 'Describe the breakdown in detail...',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                }
            });
        }

        // Show success message
        function showSuccessMessage() {
            document.getElementById('successMessage').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            // Scroll to top to show the message
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Show error message
        function showErrorMessage(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
            document.getElementById('successMessage').classList.add('hidden');
            // Scroll to top to show the message
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Hide all messages
        function hideMessages() {
            document.getElementById('successMessage').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // Reset form
        function resetForm() {
            document.getElementById('breakdownForm').reset();
            if (quill) {
                quill.setContents([]);
            }
        }

        // Set loading state
        function setLoadingState(loading) {
            const submitBtn = document.getElementById('submitBtn');
            const submitBtnText = document.getElementById('submitBtnText');
            const submitSpinner = document.getElementById('submitSpinner');

            if (loading) {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                submitBtnText.textContent = 'Submitting...';
                submitSpinner.classList.remove('hidden');
            } else {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                submitBtnText.textContent = 'Submit Breakdown Report';
                submitSpinner.classList.add('hidden');
            }
        }

        // Handle form submission
        async function handleFormSubmit(event) {
            event.preventDefault();
            hideMessages();

            const truckRegistration = document.getElementById('truckRegistration').value.trim();
            const fleetNumber = document.getElementById('fleetNumber').value.trim();
            const driverFullNames = document.getElementById('driverFullNames').value.trim();
            const cellphoneNumber = document.getElementById('cellphoneNumber').value.trim();
            const supervisorName = document.getElementById('supervisorName').value.trim();
            const supervisorCellphone = document.getElementById('supervisorCellphone').value.trim();
            const companyName = document.getElementById('companyName').value.trim();
            const location = document.getElementById('location').value.trim();
            const issueDescription = quill.getText().trim();

            // Validation
            if (!truckRegistration) {
                showErrorMessage('Please enter a truck registration number.');
                return;
            }

            if (!fleetNumber) {
                showErrorMessage('Please enter a fleet number.');
                return;
            }

            if (!driverFullNames) {
                showErrorMessage('Please enter the driver full names.');
                return;
            }

            if (!cellphoneNumber) {
                showErrorMessage('Please enter a cellphone number.');
                return;
            }

            if (!supervisorName) {
                showErrorMessage('Please enter the supervisor name.');
                return;
            }

            if (!supervisorCellphone) {
                showErrorMessage('Please enter the supervisor cellphone number.');
                return;
            }

            if (!companyName) {
                showErrorMessage('Please enter a company name.');
                return;
            }

            if (!location) {
                showErrorMessage('Please enter the breakdown location.');
                return;
            }

            if (!issueDescription || issueDescription.length < 10) {
                showErrorMessage('Please provide a detailed description of the issue (at least 10 characters).');
                return;
            }

            const slipPicture = document.getElementById('slipPicture').files[0];
            const seal1Picture = document.getElementById('seal1Picture').files[0];
            const seal2Picture = document.getElementById('seal2Picture').files[0];

            if (!slipPicture || !seal1Picture || !seal2Picture) {
                showErrorMessage('Please upload all required pictures.');
                return;
            }

            try {
                setLoadingState(true);

                const breakdownData = {
                    truck_registration_number: truckRegistration,
                    fleet_number: fleetNumber,
                    driver_full_names: driverFullNames,
                    cellphone_number: cellphoneNumber,
                    supervisor_name: supervisorName,
                    supervisor_cellphone_number: supervisorCellphone,
                    company_name: companyName,
                    breakdown_location: location,
                    issue_description: issueDescription,
                    slip_picture: slipPicture,
                    seal_1_picture: seal1Picture,
                    seal_2_picture: seal2Picture
                };

                const response = await client.createBreakdownReport(breakdownData);
                
                if (response && response.id) {
                    showSuccessMessage();
                    resetForm();
                } else {
                    throw new Error('Invalid response from server');
                }

            } catch (error) {
                console.error('Error submitting breakdown report:', error);
                showErrorMessage('Failed to submit breakdown report. Please try again later.');
            } finally {
                setLoadingState(false);
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            initializeQuill();
            getLocation(); // Automatically capture location on load
            
            // Add form submit event listener
            document.getElementById('breakdownForm').addEventListener('submit', handleFormSubmit);
        });
    </script>
</body>
</html>
