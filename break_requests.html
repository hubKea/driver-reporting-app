<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="icon" href="/favicon.jpg" type="image/jpeg"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet"/>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <title>Break Requests - Driver Reporting System</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Primary Background */
        }
        .header {
            background-color: #1f2937; /* Dark Charcoal Header */
            border-bottom: 1px solid #374151;
        }
        .header-title {
            color: #ffffff;
            font-weight: 700;
        }
        .nav-link {
            color: #d1d5db; /* Lighter text for nav links */
            font-weight: 500;
            transition: color 0.2s;
        }
        .nav-link:hover, .nav-link-active {
            color: #ffffff; /* Brighter on hover/active */
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.05), 0 1px 2px -1px rgb(0 0 0 / 0.05);
        }
        .btn-primary {
            background-color: #3b82f6; /* Vibrant Blue Accent */
            color: #ffffff;
            font-weight: 600;
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.625rem 1.25rem;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        .form-input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #bfdbfe;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <header class="shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo/Brand -->
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-white">Driver Reporting System</h1>
                    </div>
                </div>

                <!-- Desktop Navigation -->
                <nav class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="/report_breakdown.html" class="px-3 py-2 rounded-md text-sm font-medium text-white transition-colors duration-200">
                            Report Breakdown
                        </a>
                        <a href="/request_break.html" class="px-3 py-2 rounded-md text-sm font-medium text-white transition-colors duration-200">
                            Request Break
                        </a>
                        <a href="/breakdown_reports.html" class="px-3 py-2 rounded-md text-sm font-medium text-white bg-blue-700 transition-colors duration-200">
                            Breakdown Reports
                        </a>
                        <a href="/break_requests.html" class="px-3 py-2 rounded-md text-sm font-medium text-white transition-colors duration-200">
                            Break Requests
                        </a>
                    </div>
                </nav>

                <!-- User Role Indicator -->
                <div class="hidden md:block">
                    <div class="ml-4 flex items-center md:ml-6">
                        <div class="px-3 py-1 rounded-full text-xs font-medium bg-blue-700 text-white">
                            <span id="userRole">Manager</span>
                        </div>
                    </div>
                </div>

                <!-- Mobile menu button -->
                <div class="md:hidden">
                    <button type="button" class="inline-flex items-center justify-center p-2 rounded-md text-white hover:bg-blue-700 focus:outline-none" aria-controls="mobile-menu" aria-expanded="false" onclick="toggleMobileMenu()">
                        <span class="sr-only">Open main menu</span>
                        <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile menu -->
        <div class="md:hidden hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3" style="background-color: #1E40AF;">
                <a href="/report_breakdown.html" class="block px-3 py-2 rounded-md text-base font-medium text-white transition-colors duration-200" style="font-family: 'Inter', sans-serif; font-weight: 500;" onmouseover="this.style.backgroundColor='#1E3A8A'" onmouseout="this.style.backgroundColor='transparent'">
                    Report Breakdown
                </a>
                <a href="/request_break.html" class="block px-3 py-2 rounded-md text-base font-medium text-white transition-colors duration-200" style="font-family: 'Inter', sans-serif; font-weight: 500;" onmouseover="this.style.backgroundColor='#1E3A8A'" onmouseout="this.style.backgroundColor='transparent'">
                    Request Break
                </a>
                <a href="/breakdown_reports.html" class="block px-3 py-2 rounded-md text-base font-medium text-white transition-colors duration-200" style="font-family: 'Inter', sans-serif; font-weight: 500;" onmouseover="this.style.backgroundColor='#1E3A8A'" onmouseout="this.style.backgroundColor='transparent'">
                    Breakdown Reports
                </a>
                <a href="/break_requests.html" class="block px-3 py-2 rounded-md text-base font-medium text-white bg-blue-800 transition-colors duration-200">
                    Break Requests
                </a>
                <div class="border-t border-blue-600 pt-4 pb-3">
                    <div class="px-3">
                        <div class="text-xs font-medium text-blue-200">Role: <span id="mobileUserRole">Manager</span></div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Page Header -->
        <div class="px-4 py-6 sm:px-0">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Break Requests</h1>
                    <p class="mt-2 text-sm text-gray-600">Manage and review driver break requests</p>
                </div>
                <div class="flex space-x-3">
                    <button onclick="openFilterModal()" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.207A1 1 0 013 6.5V4z"></path>
                        </svg>
                        Filter by Date
                    </button>
                    <button onclick="openDownloadModal()" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Download Reports
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-sm text-gray-600">Loading break requests...</p>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="text-center py-12 hidden">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No break requests found</h3>
                <p class="mt-1 text-sm text-gray-500">No break requests match your current filters.</p>
            </div>

            <!-- Error State -->
            <div id="errorState" class="text-center py-12 hidden">
                <svg class="mx-auto h-12 w-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">Couldn't load break requests</h3>
                <p class="mt-1 text-sm text-gray-500">Please try again later.</p>
                <button onclick="loadBreakRequests()" class="mt-3 inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Try Again
                </button>
            </div>

            <!-- Break Requests Grid -->
            <div id="breakRequestsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                <!-- Break request cards will be inserted here -->
            </div>
        </div>
    </main>

    <!-- Filter Modal -->
    <div id="filterModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">​</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                        Filter Break Requests
                    </h3>
                    <div class="mt-4 space-y-4">
                        <div>
                            <label for="startDate" class="block text-sm font-medium text-gray-700">Start Date</label>
                            <input type="date" id="startDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"/>
                        </div>
                        <div>
                            <label for="endDate" class="block text-sm font-medium text-gray-700">End Date</label>
                            <input type="date" id="endDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"/>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="applyFilter()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Apply Filter
                    </button>
                    <button type="button" onclick="clearFilter()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Clear Filter
                    </button>
                    <button type="button" onclick="closeFilterModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Modal -->
    <div id="downloadModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">​</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                        Download Reports
                    </h3>
                    <div class="mt-4 space-y-4">
                        <div>
                            <label for="downloadStartDate" class="block text-sm font-medium text-gray-700">Start Date</label>
                            <input type="date" id="downloadStartDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"/>
                        </div>
                        <div>
                            <label for="downloadEndDate" class="block text-sm font-medium text-gray-700">End Date</label>
                            <input type="date" id="downloadEndDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"/>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="downloadReports()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Download
                    </button>
                    <button type="button" onclick="closeDownloadModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Break Request Details Modal -->
    <div id="detailsModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">​</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                        Break Request Details
                    </h3>
                    <div class="mt-4" id="detailsContent">
                        <!-- Details content will be inserted here -->
                    </div>
                    <div class="mt-6">
                        <label for="managerNotes" class="block text-sm font-medium text-gray-700">Manager Notes</label>
                        <textarea id="managerNotes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Add notes or comments about this break request..."></textarea>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="saveNotes()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Save Notes
                    </button>
                    <button type="button" onclick="closeDetailsModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:w-auto sm:text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import ClientAPI from '/client.js';
        
        const client = new ClientAPI();
        window.breakRequestsData = [];

        // Check authentication and role
        async function checkAuth() {
            try {
                const currentUser = await client.getCurrentStormAuthUser();
                if (currentUser.role !== 'manager') {
                    window.location.href = '/login.html'; // Redirect if not a manager
                }
                document.getElementById('userRole').textContent = 'Manager';
                document.getElementById('mobileUserRole').textContent = 'Manager';
            } catch (error) {
                console.error('Authentication check failed:', error);
                window.location.href = '/login.html'; // Redirect if there is an error
            }
        }

        async function loadBreakRequests(startDate = null, endDate = null) {
            try {
                // Show loading state
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('errorState').classList.add('hidden');
                document.getElementById('breakRequestsGrid').classList.add('hidden');
                
                // Fetch break requests
                const response = await client.getBreakRequests(startDate, endDate);
                const breakRequests = response.break_requests || [];
                
                // Store data globally for modal access
                window.breakRequestsData = breakRequests;

                // Fetch driver names for each break request
                for (let breakRequest of breakRequests) {
                    try {
                        const user = await client.getStormAuthUserById(breakRequest.user_id);
                        breakRequest.driverName = user.name || 'Unknown Driver';
                    } catch (error) {
                        breakRequest.driverName = 'Unknown Driver';
                    }
                }
                
                // Hide loading state
                document.getElementById('loadingState').classList.add('hidden');
                
                if (breakRequests.length === 0) {
                    // Show empty state
                    document.getElementById('emptyState').classList.remove('hidden');
                } else {
                    // Show break requests
                    renderBreakRequests(breakRequests);
                    document.getElementById('breakRequestsGrid').classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Error loading break requests:', error);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('errorState').classList.remove('hidden');
            }
        }
        
        function renderBreakRequests(breakRequests) {
            const grid = document.getElementById('breakRequestsGrid');
            
            grid.innerHTML = breakRequests.map(breakRequest => {
                const breakTypeColor = breakRequest.break_type === 'fatigue' ? 'bg-orange-100 text-orange-800' : 'bg-green-100 text-green-800';
                
                return `
                    <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 hover:shadow-lg transition-shadow duration-200">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">${breakRequest.driverName}</h3>
                                <p class="text-sm text-gray-600">Driver ID: ${breakRequest.user_id}</p>
                            </div>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${breakTypeColor}">
                                ${breakRequest.break_type}
                            </span>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-sm font-medium text-gray-700">Duration:</span>
                                <span class="text-sm text-gray-900">${breakRequest.break_duration} minutes</span>
                            </div>
                            
                            <div class="flex justify-between">
                                <span class="text-sm font-medium text-gray-700">Submitted:</span>
                                <span class="text-sm text-gray-900">${new Date(breakRequest.submission_date * 1000).toLocaleDateString()}</span>
                            </div>
                            
                            <div class="flex justify-between">
                                <span class="text-sm font-medium text-gray-700">Time:</span>
                                <span class="text-sm text-gray-900">${new Date(breakRequest.submission_date * 1000).toLocaleTimeString()}</span>
                            </div>
                            
                            ${breakRequest.notes ? `
                                <div>
                                    <span class="text-sm font-medium text-gray-700">Notes:</span>
                                    <p class="text-sm text-gray-900 mt-1 line-clamp-2">${breakRequest.notes}</p>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <button onclick="viewBreakRequestDetails('${breakRequest.id}')" class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                                View Details
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        }

        function openFilterModal() {
            $('#filterModal').removeClass('hidden');
        }

        function closeFilterModal() {
            $('#filterModal').addClass('hidden');
        }

        function openDownloadModal() {
            $('#downloadModal').removeClass('hidden');
        }

        function closeDownloadModal() {
            $('#downloadModal').addClass('hidden');
        }

        function openDetailsModal() {
            $('#detailsModal').removeClass('hidden');
        }

        function closeDetailsModal() {
            $('#detailsModal').addClass('hidden');
        }

        function applyFilter() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            let startTimestamp = null;
            let endTimestamp = null;
            
            if (startDate) {
                startTimestamp = Math.floor(new Date(startDate).getTime() / 1000);
            }
            if (endDate) {
                endTimestamp = Math.floor(new Date(endDate + 'T23:59:59').getTime() / 1000);
            }
            
            loadBreakRequests(startTimestamp, endTimestamp);
            closeFilterModal();
        }

        function clearFilter() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            loadBreakRequests();
            closeFilterModal();
        }

        function downloadReports() {
            const startDate = document.getElementById('downloadStartDate').value;
            const endDate = document.getElementById('downloadEndDate').value;
            
            let params = new URLSearchParams();
            if (startDate) {
                params.append('start_date', Math.floor(new Date(startDate).getTime() / 1000));
            }
            if (endDate) {
                params.append('end_date', Math.floor(new Date(endDate + 'T23:59:59').getTime() / 1000));
            }
            
            const url = `/download_reports.html?${params.toString()}`;
            window.open(url, '_blank');
            closeDownloadModal();
        }

        function saveNotes() {
            // In a real implementation, this would save the notes to the backend
            // For now, we'll just close the modal
            closeDetailsModal();
        }

        window.viewBreakRequestDetails = function(breakRequestId) {
            const breakRequest = window.breakRequestsData.find(br => br.id === breakRequestId);
            if (!breakRequest) return;
            
            const detailsContent = document.getElementById('detailsContent');
            const managerNotes = document.getElementById('managerNotes');
            
            detailsContent.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Driver Name</label>
                            <p class="mt-1 text-sm text-gray-900">${breakRequest.driverName || 'Loading...'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Break Type</label>
                            <p class="mt-1 text-sm text-gray-900">${breakRequest.break_type}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Duration</label>
                            <p class="mt-1 text-sm text-gray-900">${breakRequest.break_duration} minutes</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Submission Date</label>
                            <p class="mt-1 text-sm text-gray-900">${new Date(breakRequest.submission_date * 1000).toLocaleString()}</p>
                        </div>
                    </div>
                    ${breakRequest.notes ? `
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Driver Notes</label>
                            <p class="mt-1 text-sm text-gray-900">${breakRequest.notes}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            managerNotes.value = '';
            openDetailsModal();
        };

        // Initialize the page
        checkAuth().then(() => loadBreakRequests());
    </script>
</body>
</html>
